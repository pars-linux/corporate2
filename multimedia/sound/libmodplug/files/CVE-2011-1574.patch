From aecef259828a89bb00c2e6f78e89de7363b2237b Mon Sep 17 00:00:00 2001
From: Konstanty Bialkowski <metaplasma@users.sourceforge.net>
Date: Sat, 26 Mar 2011 12:25:00 +1000
Subject: [PATCH] Ignore corrupted s3m source.
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

Bug reported by Miroslav LuÄinskij
---
 libmodplug/src/load_s3m.cpp |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/libmodplug/src/load_s3m.cpp b/libmodplug/src/load_s3m.cpp
index f994f90..afdbb95 100644
--- a/libmodplug/src/load_s3m.cpp
+++ b/libmodplug/src/load_s3m.cpp
@@ -257,6 +257,10 @@ BOOL CSoundFile::ReadS3M(const BYTE *lpStream, DWORD dwMemLength)
 	patnum = npat = psfh.patnum;
 	if (patnum > MAX_PATTERNS) patnum = MAX_PATTERNS;
 	memset(ptr, 0, sizeof(ptr));
+
+	// Ignore file if it has a corrupted header.
+	if (nins+npat > 256) return FALSE;
+
 	if (nins+npat)
 	{
 		memcpy(ptr, lpStream+dwMemPos, 2*(nins+npat));
-- 
1.7.0.1

