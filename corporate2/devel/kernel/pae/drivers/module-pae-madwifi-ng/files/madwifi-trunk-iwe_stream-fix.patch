diff -Nur madwifi-hal-0.10.5.6-r3698-20080604.orig/net80211/ieee80211_wireless.c madwifi-hal-0.10.5.6-r3698-20080604/net80211/ieee80211_wireless.c
--- madwifi-hal-0.10.5.6-r3698-20080604.orig/net80211/ieee80211_wireless.c	2008-04-10 12:18:50.000000000 +0300
+++ madwifi-hal-0.10.5.6-r3698-20080604/net80211/ieee80211_wireless.c	2008-07-03 20:15:16.000000000 +0300
@@ -1770,6 +1770,7 @@
 
 struct iwscanreq {		/* XXX: right place for this declaration? */
 	struct ieee80211vap *vap;
+	struct iw_request_info *info;
 	char *current_ev;
 	char *end_buf;
 	int mode;
@@ -1780,6 +1781,7 @@
 {
 	struct iwscanreq *req = arg;
 	struct ieee80211vap *vap = req->vap;
+	struct iw_request_info *info = req->info;
 	char *current_ev = req->current_ev;
 	char *end_buf = req->end_buf;
 	char *last_ev;
@@ -1807,7 +1809,7 @@
 		IEEE80211_ADDR_COPY(iwe.u.ap_addr.sa_data, se->se_macaddr);
 	else
 		IEEE80211_ADDR_COPY(iwe.u.ap_addr.sa_data, se->se_bssid);
-	current_ev = iwe_stream_add_event(current_ev, end_buf, &iwe, IW_EV_ADDR_LEN);
+	current_ev = iwe_stream_add_event(info, current_ev, end_buf, &iwe, IW_EV_ADDR_LEN);
 
 	/* We ran out of space in the buffer. */
 	if (last_ev == current_ev)
@@ -1818,7 +1820,7 @@
 	iwe.cmd = SIOCGIWESSID;
 	iwe.u.data.flags = 1;
 	iwe.u.data.length = se->se_ssid[1];
-	current_ev = iwe_stream_add_point(current_ev,
+	current_ev = iwe_stream_add_point(info, current_ev,
 		end_buf, &iwe, (char *) se->se_ssid+2);
 
 	/* We ran out of space in the buffer. */
@@ -1831,7 +1833,7 @@
 		iwe.cmd = SIOCGIWMODE;
 		iwe.u.mode = se->se_capinfo & IEEE80211_CAPINFO_ESS ?
 			IW_MODE_MASTER : IW_MODE_ADHOC;
-		current_ev = iwe_stream_add_event(current_ev,
+		current_ev = iwe_stream_add_event(info, current_ev,
 			end_buf, &iwe, IW_EV_UINT_LEN);
 
 		/* We ran out of space in the buffer. */
@@ -1844,7 +1846,7 @@
 	iwe.cmd = SIOCGIWFREQ;
 	iwe.u.freq.m = se->se_chan->ic_freq * 100000;
 	iwe.u.freq.e = 1;
-	current_ev = iwe_stream_add_event(current_ev,
+	current_ev = iwe_stream_add_event(info, current_ev,
 		end_buf, &iwe, IW_EV_FREQ_LEN);
 
 	/* We ran out of space in the buffer. */
@@ -1855,7 +1857,7 @@
 	last_ev = current_ev;
 	iwe.cmd = IWEVQUAL;
 	set_quality(&iwe.u.qual, se->se_rssi, ATH_DEFAULT_NOISE);
-	current_ev = iwe_stream_add_event(current_ev,
+	current_ev = iwe_stream_add_event(info, current_ev,
 		end_buf, &iwe, IW_EV_QUAL_LEN);
 
 	/* We ran out of space in the buffer */
@@ -1870,7 +1872,7 @@
 	else
 		iwe.u.data.flags = IW_ENCODE_DISABLED;
 	iwe.u.data.length = 0;
-	current_ev = iwe_stream_add_point(current_ev, end_buf, &iwe, "");
+	current_ev = iwe_stream_add_point(info, current_ev, end_buf, &iwe, "");
 
 	/* We ran out of space in the buffer. */
 	if (last_ev == current_ev)
@@ -1879,13 +1881,13 @@
 	memset(&iwe, 0, sizeof(iwe));
 	last_ev = current_ev;
 	iwe.cmd = SIOCGIWRATE;
-	current_val = current_ev + IW_EV_LCP_LEN;
+	current_val = current_ev + iwe_stream_lcp_len(info);
 	/* NB: not sorted, does it matter? */
 	for (j = 0; j < se->se_rates[1]; j++) {
 		int r = se->se_rates[2 + j] & IEEE80211_RATE_VAL;
 		if (r != 0) {
 			iwe.u.bitrate.value = r * (1000000 / 2);
-			current_val = iwe_stream_add_value(current_ev,
+			current_val = iwe_stream_add_value(info, current_ev,
 				current_val, end_buf, &iwe,
 				IW_EV_PARAM_LEN);
 		}
@@ -1894,13 +1896,13 @@
 		int r = se->se_xrates[2+j] & IEEE80211_RATE_VAL;
 		if (r != 0) {
 			iwe.u.bitrate.value = r * (1000000 / 2);
-			current_val = iwe_stream_add_value(current_ev,
+			current_val = iwe_stream_add_value(info, current_ev,
 				current_val, end_buf, &iwe,
 				IW_EV_PARAM_LEN);
 		}
 	}
 	/* remove fixed header if no rates were added */
-	if ((current_val - current_ev) > IW_EV_LCP_LEN) {
+	if ((current_val - current_ev) > iwe_stream_lcp_len(info)) {
 		current_ev = current_val;
 	} else {
 		/* We ran out of space in the buffer. */
@@ -1913,7 +1915,7 @@
 	iwe.cmd = IWEVCUSTOM;
 	snprintf(buf, sizeof(buf), "bcn_int=%d", se->se_intval);
 	iwe.u.data.length = strlen(buf);
-	current_ev = iwe_stream_add_point(current_ev, end_buf, &iwe, buf);
+	current_ev = iwe_stream_add_point(info, current_ev, end_buf, &iwe, buf);
 
 	/* We ran out of space in the buffer. */
 	if (last_ev == current_ev)
@@ -1937,7 +1939,7 @@
 				rsn_leader, sizeof(rsn_leader) - 1);
 #endif
 		if (iwe.u.data.length != 0) {
-			current_ev = iwe_stream_add_point(current_ev, end_buf,
+			current_ev = iwe_stream_add_point(info, current_ev, end_buf,
 				&iwe, buf);
 
 			/* We ran out of space in the buffer */
@@ -1963,7 +1965,7 @@
 			wpa_leader, sizeof(wpa_leader) - 1);
 #endif
 		if (iwe.u.data.length != 0) {
-			current_ev = iwe_stream_add_point(current_ev, end_buf,
+			current_ev = iwe_stream_add_point(info, current_ev, end_buf,
 				&iwe, buf);
 
 			/* We ran out of space in the buffer. */
@@ -1982,7 +1984,7 @@
 			se->se_wme_ie, se->se_wme_ie[1] + 2,
 			wme_leader, sizeof(wme_leader) - 1);
 		if (iwe.u.data.length != 0) {
-			current_ev = iwe_stream_add_point(current_ev, end_buf,
+			current_ev = iwe_stream_add_point(info, current_ev, end_buf,
 				&iwe, buf);
 
 			/* We ran out of space in the buffer. */
@@ -2000,7 +2002,7 @@
 			se->se_ath_ie, se->se_ath_ie[1] + 2,
 			ath_leader, sizeof(ath_leader) - 1);
 		if (iwe.u.data.length != 0) {
-			current_ev = iwe_stream_add_point(current_ev, end_buf,
+			current_ev = iwe_stream_add_point(info, current_ev, end_buf,
 				&iwe, buf);
 
 			/* We ran out of space in the buffer. */
