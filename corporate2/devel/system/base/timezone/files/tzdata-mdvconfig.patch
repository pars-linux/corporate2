Index: tzdata/Makeconfig.in
===================================================================
--- tzdata.orig/Makeconfig.in
+++ tzdata/Makeconfig.in
@@ -1,8 +1,9 @@
-objpfx := @objpfx@
-datadir := @datadir@
-install_root := @install_root@
+ifdef subdir
+.. := ../
+endif
+include $(..)config.mk
 AWK := awk
-built-program-cmd := /usr/sbin/zic
+built-program-cmd := $(objpfx)/zic
 cross-compiling := no
 have-ksh := yes
 +force =
@@ -11,3 +12,20 @@ posixrules = America/New_York
 posixrules-file = posixrules
 zonedir := $(datadir)/zoneinfo
 inst_zonedir := $(install_root)$(zonedir)
+inst_sysconfdir = $(install_root)$(sysconfdir)
+localtime = Factory
+inst_sbindir = $(install_root)$(sbindir)
+
+# These are the variables that the implicit compilation rules use.
+# Note that we can't use -std=* in CPPFLAGS, because it overrides
+# the implicit -lang-asm and breaks cpp behavior for .S files--notably
+# it causes cpp to stop predefining __ASSEMBLER__.
+CPPFLAGS = $(sysdep-CPPFLAGS) \
+	$(CPPFLAGS-$(suffix $@)) \
+	$(CPPFLAGS-$(<F)) $(CPPFLAGS-$(@F)) $(CPPFLAGS-$(basename $(@F)))
+override CFLAGS = $(sysdep-CFLAGS) -std=gnu99 \
+	$(CFLAGS-$(suffix $@)) $(CFLAGS-$(<F)) \
+	$(CFLAGS-$(@F))
+
+$(objpfx)%.o: %.c
+	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@
Index: tzdata/Rules
===================================================================
--- tzdata.orig/Rules
+++ tzdata/Rules
@@ -1,9 +1,3 @@
-$(objpfx)zic: /dev/null
-	touch $@
-$(objpfx)scheck.o: /dev/null
-	touch $@
-$(objpfx)ialloc.o: /dev/null
-	touch $@
 define make-target-directory
 $(addprefix mkdir -p ,\
 	    $(filter-out $(wildcard $(@D:%/=%)),$(@D:%/=%)))
@@ -12,7 +6,28 @@ define do-install
 $(make-target-directory)
 /usr/bin/install -m 644 $< $@
 endef
-install: $(inst_zonedir)/
+define do-install-program
+$(make-target-directory)
+/usr/bin/install -m 755 $< $@.new
+mv -f $@.new $@
+endef
+install: install-zoneinfo install-programs
+
+install-zoneinfo: $(inst_zonedir)/
 	$(MAKE) install-data
 $(inst_zonedir)/: ; $(make-target-directory)
 install-data: $(install-others)
+
+ifdef install-sbin
+$(addprefix $(inst_sbindir)/,$(install-sbin)): \
+    $(inst_sbindir)/%: $(objpfx)% $(+force)
+	$(do-install-program)
+installed-programs += $(addprefix $(inst_sbindir)/,$(install-sbin))
+endif
+
+install-programs: $(installed-programs)
+
+others: $(addprefix $(objpfx),$(extra-objs) \
+                              $(install-lib) \
+                              $(install-bin) \
+                              $(install-rootsbin) $(install-sbin))
Index: tzdata/Makefile
===================================================================
--- tzdata.orig/Makefile
+++ tzdata/Makefile
@@ -1,6 +1,13 @@
-all:
-	mkdir obj
+all: prepare
+	$(MAKE) -C src others
+
+OBJ_DIR = obj
+$(OBJ_DIR)::
+	@[ -d $(OBJ_DIR) ] || mkdir $(OBJ_DIR) > /dev/null 2>&1
+
+prepare: $(OBJ_DIR)
 	for i in tzdata*/*; do ln -sf ../$$i src/; done
+	for i in tzcode*/*.[ch]; do ln -sf ../$$i src/; done
 	cp -L src/yearistype.sh src/yearistype; chmod +x src/yearistype
 
 include ./Makeconfig
