From a03617089bc045e343f94921f257cf71436f4812 Mon Sep 17 00:00:00 2001
From: =?utf8?q?R=C3=A9mi=20Denis-Courmont?= <remi@remlab.net>
Date: Mon, 26 Sep 2011 18:28:19 +0300
Subject: [PATCH] Fix HTTP/RTSP crash on invalid request URI

---
 src/network/httpd.c |   19 +++++++++++++++----
 1 files changed, 15 insertions(+), 4 deletions(-)

Index: vlc-1.1.9/src/network/httpd.c
===================================================================
--- vlc-1.1.9.orig/src/network/httpd.c
+++ vlc-1.1.9/src/network/httpd.c
@@ -1755,16 +1755,27 @@ static void httpd_ClientRecv( httpd_clie
                             *p2++ = '\0';
                         }
                         if( !strncasecmp( p, ( cl->query.i_proto
-                                   == HTTPD_PROTO_HTTP ) ? "http" : "rtsp", 4 )
-                         && p[4 + !!strchr( "sS", p[4] )] == ':' )
+                                == HTTPD_PROTO_HTTP ) ? "http:" : "rtsp:", 5 ) )
                         {   /* Skip hier-part of URL (if present) */
                             p = strchr( p, ':' ) + 1; /* skip URI scheme */
                             if( !strncmp( p, "//", 2 ) ) /* skip authority */
                             {   /* see RFC3986 ยง3.2 */
                                 p += 2;
-                                while( *p && !strchr( "/?#", *p ) ) p++;
+                                p += strcspn( p, "/?#" );
                             }
                         }
+                        else
+                        if( !strncasecmp( p, ( cl->query.i_proto
+                            == HTTPD_PROTO_HTTP ) ? "https:" : "rtsps:", 6 ) )
+                        {   /* Skip hier-part of URL (if present) */
+                            p += 6;
+                            if( !strncmp( p, "//", 2 ) ) /* skip authority */
+                            {   /* see RFC3986 รยง3.2 */
+                                p += 2;
+                                p += strcspn( p, "/?#" );
+                            }
+                        }
+
                         cl->query.psz_url = strdup( p );
                         if( ( p3 = strchr( cl->query.psz_url, '?' ) )  )
                         {
