From 0a1614101be51f9ee45af18bff24f5726052d36d Mon Sep 17 00:00:00 2001
From: Ben Skeggs <bskeggs@redhat.com>
Date: Wed, 9 Sep 2009 16:26:25 +1000
Subject: [PATCH 3/3] f12: use 0x7000 flags for scanout to avoid mixed tile mode corruption

---
 src/drmmode_display.c |    4 ++--
 src/nv_driver.c       |    7 ++++++-
 src/nv_type.h         |    2 ++
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/drmmode_display.c b/src/drmmode_display.c
index d1e3ec3..fe2539d 100644
--- a/src/drmmode_display.c
+++ b/src/drmmode_display.c
@@ -460,7 +460,7 @@ drmmode_crtc_shadow_allocate(xf86CrtcPtr crtc, int width, int height)
 
 	if (pNv->Architecture >= NV_ARCH_50) {
 		tile_mode = 4;
-		tile_flags = (drmmode->cpp == 2) ? 0x7000 : 0x7a00;
+		tile_flags = (drmmode->cpp == 2 || pNv->pf_ok) ? 0x7000 : 0x7a00;
 		ah = NOUVEAU_ALIGN(height, 1 << (tile_mode + 2));
 		pitch = NOUVEAU_ALIGN(width * drmmode->cpp, 64);
 	} else {
@@ -1068,7 +1068,7 @@ drmmode_xf86crtc_resize(ScrnInfoPtr scrn, int width, int height)
 
 	if (pNv->Architecture >= NV_ARCH_50 && pNv->wfb_enabled) {
 		tile_mode = 4;
-		tile_flags = (scrn->bitsPerPixel == 16) ? 0x7000 : 0x7a00;
+		tile_flags = (scrn->bitsPerPixel == 16 || pNv->pf_ok) ? 0x7000 : 0x7a00;
 		ah = NOUVEAU_ALIGN(height, 1 << (tile_mode + 2));
 		pitch = NOUVEAU_ALIGN(width * (scrn->bitsPerPixel >> 3), 64);
 	} else {
diff --git a/src/nv_driver.c b/src/nv_driver.c
index f07bc12..c907015 100644
--- a/src/nv_driver.c
+++ b/src/nv_driver.c
@@ -692,6 +692,7 @@ NVPreInitDRM(ScrnInfoPtr pScrn)
 {
 	NVPtr pNv = NVPTR(pScrn);
 	drmVersion *version;
+	uint64_t val;
 	char *bus_id;
 	int ret;
 
@@ -738,6 +739,10 @@ NVPreInitDRM(ScrnInfoPtr pScrn)
 		return FALSE;
 	}
 
+	ret = nouveau_device_get_param(pNv->dev, 0xdeadcafe00000003, &val);
+	if (ret == 0)
+		pNv->pf_ok = (val == 1);
+
 	/* Check if KMS is enabled before we do anything, we don't want to
 	 * go stomping on registers behind its back
 	 */
@@ -1252,7 +1257,7 @@ NVMapMem(ScrnInfoPtr pScrn)
 	size = pScrn->displayWidth * (pScrn->bitsPerPixel >> 3);
 	if (pNv->Architecture >= NV_ARCH_50 && pNv->tiled_scanout) {
 		tile_mode = 4;
-		tile_flags = pScrn->bitsPerPixel == 16 ? 0x7000 : 0x7a00;
+		tile_flags = (pScrn->bitsPerPixel == 16 || pNv->pf_ok) ? 0x7000 : 0x7a00;
 		size *= NOUVEAU_ALIGN(pScrn->virtualY, (1 << (tile_mode + 2)));
 	} else {
 		size *= pScrn->virtualY;
diff --git a/src/nv_type.h b/src/nv_type.h
index 0c13dac..55aa8c0 100644
--- a/src/nv_type.h
+++ b/src/nv_type.h
@@ -113,6 +113,8 @@ typedef struct _NVRec {
     /* Accessible AGP size */
     unsigned long	AGPSize;
 
+    Bool pf_ok;
+
     /* Various pinned memory regions */
     struct nouveau_bo * scanout;
     struct nouveau_bo * offscreen;
-- 
1.6.5.2

