Index: linux-2.6.30/fs/nfs/dir.c
===================================================================
--- linux-2.6.30.orig/fs/nfs/dir.c
+++ linux-2.6.30/fs/nfs/dir.c
@@ -1026,13 +1026,13 @@ static struct dentry *nfs_atomic_lookup(
 				res = NULL;
 				goto out;
 			/* This turned out not to be a regular file */
-			case -EISDIR:
 			case -ENOTDIR:
 				goto no_open;
 			case -ELOOP:
 				if (!(nd->intent.open.flags & O_NOFOLLOW))
 					goto no_open;
 			/* case -EINVAL: */
+			/* case -EISDIR: */
 			default:
 				goto out;
 		}
Index: linux-2.6.30/fs/nfs/nfs4proc.c
===================================================================
--- linux-2.6.30.orig/fs/nfs/nfs4proc.c
+++ linux-2.6.30/fs/nfs/nfs4proc.c
@@ -3598,14 +3598,23 @@ nfs4_proc_lock(struct file *filp, int cm
 	if (request->fl_start < 0 || request->fl_end < 0)
 		return -EINVAL;
 
-	if (IS_GETLK(cmd))
-		return nfs4_proc_getlk(state, F_GETLK, request);
+	if (IS_GETLK(cmd)) {
+		if (state != NULL)
+			return nfs4_proc_getlk(state, F_GETLK, request);
+		return 0;
+	}
 
 	if (!(IS_SETLK(cmd) || IS_SETLKW(cmd)))
 		return -EINVAL;
 
-	if (request->fl_type == F_UNLCK)
-		return nfs4_proc_unlck(state, cmd, request);
+	if (request->fl_type == F_UNLCK) {
+		if (state != NULL)
+			return nfs4_proc_unlck(state, cmd, request);
+		return 0;
+	}
+
+	if (state == NULL)
+		return -ENOLCK;
 
 	do {
 		status = nfs4_proc_setlk(state, cmd, request);
